<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Weather App</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
        <link rel="stylesheet" href="./assets/css/style.css" />
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-dark bg-dark" id="navbar">
            <span class="navbar-brand mb-0 h1">Weather Dashboard</span>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- City Search -->
                <div class="col-4 search">
                    <label for="city">Search for a City:</label>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="cityName">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit" id="submitBtn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <!-- Past City Search Buttons -->
                    <div id="pastSearch"></div>
                </div>
                <!-- City Weather Data Display -->
                <div class="col-8">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <h5 class="card-title"><span id="cityDisplay"></span> <span id="dateDisplay"></span><img id="currentConditionDisplay"></img></h5>
                                <p>Temperature: <span id="tempDisplay"></span> &deg;F</p>
                                <p>Humidity: <span id="humidityDisplay"></span>%</p>
                                <p>Wind Speed: <span id="windSpeedDisplay"></span> MPH</p>
                                <p>UV Index: <span id="uvIndexDisplay"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h5>5-Day Forecast:</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Font Awesome link -->
        <script src="https://kit.fontawesome.com/c79351aee9.js" crossorigin="anonymous"></script>
        <!-- jQuery link -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!-- Moment.js link-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
        <!-- External JS file link -->
        <script src="./assets/js/script.js"></script>

        <script>
            let pastCityList = [];
            let city;

            function searchForWeather(){
                city = $("#cityName").val();
                if(pastCityList.includes(city)){
                    console.log("city already in list, not adding again")
                } else{
                    pastCityList.push(city);
                    localStorage.setItem("pastCityList", JSON.stringify(pastCityList));
                };
                
                init();

                let queryURL = "https://api.openweathermap.org/data/2.5/weather?q="+ city +"&appid=72de2b75c6774a8a71e7061642ea7d3a"

                $.ajax({
                    url: queryURL,
                    method: "GET"
                }).then(function(response){
                    //records the lon and lat of the city searched to use in another ajax call
                    let lon = response.coord.lon;
                    let lat = response.coord.lat;

                    $.ajax({
                        url: "https://api.openweathermap.org/data/2.5/onecall?lat="+ lat +"&lon="+ lon + "&exclude=hourly,minutely&appid=72de2b75c6774a8a71e7061642ea7d3a",
                        method: "GET"
                    }).then(function(response){
                        let fTemp = Math.round(Math.floor(response.current.temp) * 9/5 - 459.67);
                        let currentHum = response.current.humidity;
                        let wind = response.current.wind_speed;
                        let uvi = parseInt(response.current.uvi);
                        let conditionIcon = response.current.weather[0].icon;
                        let condition = "http://openweathermap.org/img/wn/"+ conditionIcon +"@2x.png";
                        let uvDisplay = $("#uvIndexDisplay");
                        $("#cityDisplay").text(city);
                        $("#dateDisplay").text("(" + moment().format('l') + ")");
                        $("#currentConditionDisplay").attr("src", condition)
                        $("#tempDisplay").text(fTemp);
                        $("#humidityDisplay").text(currentHum);
                        $("#windSpeedDisplay").text(wind);
                        uvDisplay.text(uvi);

                        if(uvi < 3){
                            uvDisplay.attr("class", "badge badge-success")
                        } else if(3 < uvi && uvi < 6){
                            uvDisplay.attr("class", "badge badge-warning")
                        } else if(6 < uvi && uvi < 7){
                            uvDisplay.attr("class", "badge badge-orange")
                        } else {
                            uvDisplay.attr("class", "badge badge-danger")
                        };


                        console.log("temp: " + fTemp);
                        console.log("humidity: " + currentHum);
                        console.log("uvi: "+ uvi);
                        console.log("condition Icon: "+ conditionIcon);
                        console.log(response);
                    })
                    
                });
            };

            function init(){
                let storedCityData = localStorage.getItem("pastCityList");
                if(storedCityData !== null){
                    pastCityList = JSON.parse(storedCityData);
                    console.log(pastCityList);

                    $("#pastSearch").empty();
                    for(var i = 0; i < pastCityList.length; i++){
                        let cityBtn = $("<button>");
                        cityBtn.text(pastCityList[i]);
                        cityBtn.attr("class", "btn btn-light btn-lg btn-block mb-2");
                        $("#pastSearch").prepend(cityBtn);
                    };

                } else {
                    console.log("nothing in local storage");
                };
                
            }

            $("button").on("click", function(event){
                event.preventDefault();
                
                if($(this).attr("id") === "submitBtn"){
                    searchForWeather();
                } else {
                    console.log("not the submit btn")
                }
                
            });

            init();










        </script>
    </body>
</html>